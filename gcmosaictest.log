# This is a log of analysis done for ATA observation gcmosaictest
# Casey Law, 4Feb09

# set up a few variables...

lupus>set SRC = 'gcmosaictest1'
lupus>set CAL = '1733-130'
Lupus>set FREQ = '1640'
Lupus>set VIS = fx64c-${SRC}-${FREQ}
Lupus>set CALVIS = fx64c-${CAL}-${FREQ}
lupus>set VIS2 = ${SRC}-${FREQ}
lupus>set CALVIS2 = ${CAL}-${FREQ}

# find central location for ref antenna

lupus>listobs vis=${VIS}_1

listobs: Version 1.26, 2008/12/12 16:11:11 UTC

Opening File: fx64c-gcmosaictest1-1640_1
                SUMMARY OF OBSERVATIONS
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
Input file: fx64c-gcmosaictest1-1640_1
--------------------------------------------------------------------------------
         Antenna and Baseline Information
         --------------------------------
            Antenna Locations (in nsec)            Antenna Locations (in m)
                 X           Y           Z              E           N           U
Antenna  1:   388.0056   -345.9593   -446.4421      -103.716    -177.323       0.547
Antenna  2:   424.0466   -231.8771   -489.3340       -69.515    -194.117       0.319
Antenna  3:   567.9068   -257.3914   -646.5314       -77.164    -257.973       2.154
Antenna  4:   555.5537   -336.3360   -640.4653      -100.831    -254.176       0.540
Antenna  5:   531.1626   -384.1224   -613.8685      -115.157    -243.362       0.218
Antenna  6:   534.0651   -482.1836   -615.6369      -144.555    -244.332       0.530
Antenna  8:   456.9556   -567.1624   -526.4819      -170.031    -208.994       0.506
Antenna 11:   214.0994   -257.8551   -245.2209       -77.303     -97.591       0.522
Antenna 12:   236.9467   -181.3621   -271.7143       -54.371    -108.079       0.514
Antenna 13:   296.7146   -196.5793   -341.4903       -58.933    -135.622       0.401
Antenna 14:   343.4076    -65.1551   -395.3423       -19.533    -156.990       0.442
Antenna 15:   337.2935     -7.3884   -388.3348        -2.215    -154.202       0.428
Antenna 16:   307.3218   -485.5893   -353.7408      -145.576    -140.480       0.407
Antenna 17:   311.6926   -582.5463   -358.3930      -174.643    -142.392       0.487
Antenna 18:   284.7790   -558.0227   -327.5794      -167.291    -130.127       0.419
Antenna 22:   241.4553   -296.9588   -278.2969       -89.026    -110.456       0.247
Antenna 23:   142.8147    -15.9310   -163.6671        -4.776     -65.119       0.330
Antenna 24:    93.8221   -170.3679   -107.1424       -51.075     -42.694       0.291
Antenna 25:   117.6689   -258.8224   -135.0380       -77.593     -53.696       0.235
Antenna 26:   144.6921   -311.6022   -165.7744       -93.416     -65.965       0.343
Antenna 27:   150.0026   -343.3976   -171.9025      -102.948     -68.396       0.347
Antenna 28:   131.3512   -334.1779   -146.3734      -100.184     -58.949       1.118
Antenna 32:    36.7439    -81.3129    -41.3990       -24.377     -16.593       0.224
Antenna 33:    -5.9286   -173.8903      7.9920       -52.131       2.975       0.221
Antenna 36:    -0.1126    -36.2050      0.9826       -10.854       0.245       0.167
Antenna 37:    -0.0182     -0.0434      0.0415        -0.013       0.013       0.004
Antenna 39:    56.7748    276.5980    -64.0397        82.922     -25.655       0.332
Antenna 40:    75.2324    312.0259    -84.5220        93.543     -33.919       0.506
Antenna 41:    86.5614    222.5106    -98.5114        66.707     -39.313       0.335
Antenna 42:    58.0335    231.8604    -65.5838        69.510     -26.252       0.315
--------------------------------------------------------------------------------
           Baselines in Wavelengths
           ------------------------
      for Decl = 0 deg. Source at Transit
                 U           V           W           UVdistance
Bsln   1- 2:    -187.09       70.34      -59.11      199.88
Bsln   1- 3:    -145.25      328.15     -295.04      358.86
Bsln   1- 4:     -15.78      318.20     -274.78      318.59
Bsln   1- 5:      62.59      274.58     -234.78      281.62

...

Bsln  39-42:      73.37        2.53       -2.06       73.41
Bsln  40-41:     146.81       22.94      -18.58      148.59
Bsln  40-42:     131.47      -31.06       28.21      135.09
Bsln  41-42:     -15.33      -54.00       46.79       56.14
--------------------------------------------------------------------------------
            Observed Sources Coordinates and Corr Freqs
Source         Purpose    RA         Decl         Vlsr            Corfs in MHz
gcmosaictest1             17 44 24.75 -28 46 27.53    0.00E+00     0.0
gcmosaictest1             17 44 24.75 -28 46 27.53    0.00E+00     0.0
gcmosaictest1             17 44 24.75 -28 46 27.53    0.00E+00     0.0
gcmosaictest1             17 44 24.75 -28 46 27.53    0.00E+00     0.0
gcmosaictest1             17 44 24.75 -28 46 27.53    0.00E+00     0.0
gcmosaictest1             17 44 24.75 -28 46 27.53    0.00E+00     0.0
gcmosaictest1             17 44 24.75 -28 46 27.53    0.00E+00     0.0
gcmosaictest1             17 44 24.75 -28 46 27.53    0.00E+00     0.0
gcmosaictest1             17 44 24.75 -28 46 27.53    0.00E+00     0.0
--------------------------------------------------------------------------------
                         Frequency Set-up
   Source: gcmosaictest1              UT: 151545.4              LST: 160536.1
Line Code: unknown    Rest Freq:    1.6400 GHz     IF Freq:   629.146 MHz
Velo Code: VELO-LSR   Anten Vel:      0.00 km/s   First LO:    0.0000 GHz
--------------------------------------------------------------------------------
               Chronology of Observations on 09FEB03
Source              UT      LST     Dur Elev       Sys Temps (K)
At line 645 of file listobs.f
Fortran runtime error: End of file

lupus>set REFANT = 13

# take a look visibilities

lupus>itemize in=${VIS}_1

itemize: Version 1.4, 2008/02/19 20:06:29 UTC

  vislen   = 752110784
  ncorr    = 182476800
  nwcorr   = 0
  obstype  = mixed-auto-cross
  flags      (integer data, 5886349 elements)
  vartable   (text data, 384 elements)
  history    (text data, 67748 elements)
  visdata    (binary data, 752110780 elements)

lupus>prthd in=${VIS}_1
Prthd: version 11-jul-07
****************************************************************
Filename: fx64c-gcmosaictest1-1640_1
Telescope: ATA
Object: gcmosaictest1
First time: 09FEB03:15:15:45.0
Number of antennae: 43
Polarisations Present: XX,YY,XX,XX
Type of correlations present: mixed-auto-cross
----------------------------------------------------------------
Spectral Correlations:
  Spectrum  Channels  Freq(chan=1)  Increment  Restfreq
      1        512       1.58757     0.000102   1.64000 GHz
  Total number of correlations: 18247680
  Correlations are stored in 16-bit form
----------------------------------------------------------------
J2000    Source RA: 17:44:24.748  Dec: -28:46:27.53
Apparent Source RA: 17:44:59.366  Dec: -28:46:39.69

# plot and check raw data

smauvspec vis=${VIS}_1 device=1/xs axis=ch,bo select='pol(xx,yy),ant(1,2,3)(11,12,13,14)' nxy=4,3

# plot shows massive lines which change on time scales of a minute or so.  seems to be near 1612 and 1680 or so, but changes a lot between baselines.  probably rfi.  
# also, it is in the cal.  definitely rfi.

# several stumbles once starting to use miriad.  local version from mel is different from karto, so RAPIDBeta fails.  set up different version available on lupus, but wip gives problems.  setting paths to get all libraries set up properly.  ultimately success, but wip still complains about lack of initialization file.

# now runs newrfisweep.csh ok

lupus>newrfisweep.csh vis=fx64c-gcmosaictest1-1640_1
Gathering observation information...
Reconstructing observational parameters...
Building files for cycle 001...
Building files for cycle 002...
Building files for cycle 003...
Building files for cycle 004...
Building files for cycle 005...
Building files for cycle 006...
Building files for cycle 007...
Building files for cycle 008...
Beginning cycle 001 (of 8)...
Beginning corruption detection and recovery...
1 potentially corrupted antennas found...
Corrupted antennas recovered...
Beginning cycle 1 (of 8) scanning...
Beginning cycle 1 (of 8) flagging. 120 channels to flag in 11 iterations.
............
Completed cycle. Processing time was 1 minute(s) 10 second(s).
Beginning cycle 002 (of 8)...
Beginning cycle 2 (of 8) scanning...
Beginning cycle 2 (of 8) flagging. 139 channels to flag in 10 iterations.
...........
Completed cycle. Processing time was 0 minute(s) 25 second(s).
Beginning cycle 003 (of 8)...
Beginning cycle 3 (of 8) scanning...
Could not open user's WIP initialization file.
Beginning cycle 3 (of 8) flagging. 145 channels to flag in 11 iterations.
............
Completed cycle. Processing time was 0 minute(s) 28 second(s).
Beginning cycle 004 (of 8)...
Beginning cycle 4 (of 8) scanning...
Beginning cycle 4 (of 8) flagging. 147 channels to flag in 10 iterations.
...........
Completed cycle. Processing time was 0 minute(s) 25 second(s).
Beginning cycle 005 (of 8)...
Beginning corruption detection and recovery...
1 potentially corrupted antennas found...
Decorruption subcycle 5.1 (of 1) complete...
Corrupted antennas recovered...
Beginning cycle 5 (of 8) scanning...
Beginning cycle 5 (of 8) flagging. 131 channels to flag in 14 iterations.
...............
Completed cycle. Processing time was 1 minute(s) 20 second(s).
Beginning cycle 006 (of 8)...
Beginning cycle 6 (of 8) scanning...
Beginning cycle 6 (of 8) flagging. 124 channels to flag in 7 iterations.
........
Completed cycle. Processing time was 0 minute(s) 19 second(s).
Beginning cycle 007 (of 8)...
Beginning cycle 7 (of 8) scanning...
Could not open user's WIP initialization file.
Beginning cycle 7 (of 8) flagging. 185 channels to flag in 13 iterations.
..............
Completed cycle. Processing time was 0 minute(s) 33 second(s).
Beginning cycle 008 (of 8)...
Beginning cycle 8 (of 8) scanning...
Could not open user's WIP initialization file.
Beginning cycle 8 (of 8) flagging. 191 channels to flag in 14 iterations.
...............
Completed cycle. Processing time was 0 minute(s) 31 second(s).
fx64c-gcmosaictest1-1640_1 final flagging...
UvAver: version 1.0 17-Nov-08
Uvaflag: version 1.0 22-Oct-98
 Correlations: Total   Good      Bad
 Before:    ********9500166087475140
 After:     ********9370971088767090
Edge flagging fx64c-gcmosaictest1-1640_1
Flagging of fx64c-gcmosaictest1-1640_1 complete!
Flagging process took 6 minute(s) 19 second(s).

# first spectral half of cal shows whopping high lump in unflagged channels from 100-200.  similarly (but not quite as strong) for second half of cal in channels from 300-400.  ??some kind of renormalization??

# flagged by hand the first 200 channels in cal half 1 and last 200 channels of cal half 2

# flagged first 200 chans of first half of gcmosaictest1.  second half looks ok.

# now gluing halves together for cal and gcmosaictest1.  need to force ataglue.py to use python2.5 or else it gets upset with 64-bit or a library thingy...  glued.

lupus>~/big_scr2/code/mmm/pwilliams/fancy/ataglue.py vis=${VIS}_1,${VIS}_2 out=${VIS}
lupus>~/big_scr2/code/mmm/pwilliams/fancy/ataglue.py vis=${CALVIS}_1,${CALVIS}_2 out=${CALVIS}

# check that they are stitched together ok:
smauvspec vis=fx64c-1733-130-1640 device=1/xs axis=ch,bo select='pol(xx,yy),ant(1,2)(11,12)' nxy=2,2

# seems ok, but there is less of a gap between the halves than I expected.  ?? is there significant overlap in the halves somehow (that ataglue knows about)??

# now run uvcal to flatten baselines a bit to help further flagging

lupus>uvcal options=fxcal,unflagged select='pol(yy)' vis=fx64c-gcmosaictest1-1640 out=fx64c-gcmosaictest1-1640-yy
UVCAL: version 4-dec-2008
### Informational [uvcal]:  05aug05 seeing correction for coherence
### Informational [uvcal]:  28jan06 options=avechan. Make new wideband
### Informational [uvcal]:  25feb06 options=holo: pointing and holography
### Informational [uvcal]:  05mar06 options=slope: phase slope and baseline
### Informational [uvcal]:  14mar07 options=noisecal: copy conj LSB into USB
### Informational [uvcal]:  01oct07 keyword onsource to set uvvariable on
### Informational [uvcal]:  20nov08 options=atmcal available

# etc. etc.

# use uvspec to check on difference.

uvspec vis=fx64c-1733-130-1640-xx device=1/xs axis=ch,amp select='pol(xx,yy),ant(1,2)(11,12)' nxy=2,2

# check walsh flags => seems to be none according to peter's walsh-flags.py

# now try peter's closure phase analysis script:  closanal.py.  again hacked to use python2.5.

lupus>~/big_scr2/code/mmm/pwilliams/fancy/closanal vis=fx64c-1733-130-1640-xx interval=10
CLOSANAL: attempt to identify bad baselines based on closure quantities (Python, SVN r218, modified 2008-11-24 04:18:35Z)
Configuration:
  Averaging interval: 10 minutes
  Calculating phase closure triples
Reading data ... done.
  Read 2925 phase closure triples.

Triples with worst phase closure values:
         Triple             RMS
    12X-26X-37X:         129.01
    26X-27X-28X:        130.082
    13X-18X-26X:        130.826
     8X-11X-26X:        131.071
     4X-26X-42X:         133.83
    13X-15X-26X:        135.418
    14X-26X-36X:        135.704
     6X-16X-26X:         136.36
      2X-3X-26X:        137.058
    26X-32X-36X:        146.336

Basepols with worst phase closure values:
        Basepol       Mean(RMS) (    StdDev, nTrip)
        11X-26X:        103.276 (   16.2383,    25)
        17X-26X:        103.298 (   10.9311,    25)
         8X-26X:        103.693 (   13.2778,    25)
         2X-26X:        103.726 (   14.8078,    25)
        26X-33X:        103.788 (   11.9165,    25)
         1X-26X:        104.272 (   13.2805,    25)
        15X-26X:        104.849 (   14.2863,    25)
        13X-26X:        104.868 (   13.9556,    25)
        26X-36X:        108.137 (   13.6557,    25)
         3X-26X:        109.125 (   13.3115,    25)

Antpols with worst phase closure values:
         Antpol       Mean(RMS) (    StdDev, nTrip)
            24X:        16.9785 (   26.1446,   325)
            28X:        17.0461 (    25.825,   325)
             1X:         17.264 (   26.0932,   325)
            15X:        17.3353 (   26.6291,   325)
            16X:        18.3183 (   26.1839,   325)
            23X:        19.4642 (   25.4533,   325)
            18X:        19.8971 (   25.5026,   325)
            14X:        21.5524 (    25.065,   325)
            42X:        30.4891 (   24.4205,   325)
            26X:        102.813 (   14.2168,   325)

# and now repeat with opt=best.

lupus>~/big_scr2/code/mmm/pwilliams/fancy/closanal vis=fx64c-1733-130-1640-xx interval=10 options=best
CLOSANAL: attempt to identify bad baselines based on closure quantities (Python, SVN r218, modified 2008-11-24 04:18:35Z)
Configuration:
  Averaging interval: 10 minutes
  Calculating phase closure triples
Reading data ... done.
  Read 2925 phase closure triples.

Triples with best phase closure values:
         Triple             RMS
      1X-6X-24X:        1.90055
     6X-11X-36X:        2.50294
     1X-11X-33X:        2.64096
     5X-27X-36X:        2.72183
     5X-25X-32X:        2.73544
     5X-16X-41X:        2.81701
     3X-11X-17X:        2.85417
    16X-32X-37X:        2.86896
     3X-17X-33X:        2.95494
     5X-11X-23X:        3.00953

Basepols with best phase closure values:
        Basepol       Mean(RMS) (    StdDev, nTrip)
        11X-28X:        9.66003 (    14.407,    25)
          6X-8X:        9.66629 (    16.704,    25)
        11X-15X:        9.73114 (   13.3801,    25)
         8X-25X:        9.95867 (   13.9149,    25)
         3X-36X:        9.97081 (   16.0484,    25)
         4X-25X:        10.0454 (   13.9764,    25)
         3X-17X:        10.0552 (   21.1767,    25)
        24X-37X:        10.1013 (   13.1052,    25)
        25X-37X:        10.1994 (   16.0973,    25)
        11X-25X:         10.279 (     16.72,    25)

Antpols with best phase closure values:
         Antpol       Mean(RMS) (    StdDev, nTrip)
             8X:        15.9714 (   26.1842,   325)
            25X:        15.9863 (   25.4464,   325)
            11X:        16.0449 (   26.1629,   325)
            17X:        16.2986 (   25.9787,   325)
             6X:        16.3315 (   26.3998,   325)
             5X:        16.4218 (   25.5455,   325)
             4X:        16.4595 (   25.6821,   325)
            13X:        16.5399 (   26.2292,   325)
             3X:        16.5993 (   27.4022,   325)
            41X:        16.6754 (   26.1662,   325)

# ant 26 bad for x:

uvflag vis=fx64c-1733-130-1640-xx select='ant(26)' flagval=flag

# again for y.   better afterwards.  still some antpols have mean rms closure that is 1.5 times the std of the rms.  ?? what is considered ok??

# just got an email about an error with the atafx data catcher.  it set the frequency assuming a different correlator:

lupus>uvlist vis=mosfxc-1733-130-1640 options=var,full | grep 'freq'
epoch   :  2000.00       freq    :   1.4300       humid%  :  85.0000
restfreq:   1.4300       sdf     :  1.02400E-04   sfreq   :   1.3776

# resetting to be the same as the fxmir values.  repeated for each target...

puthd in=mosfxc-1733-130-1640/freq value=1.640
puthd in=mosfxc-1733-130-1640/sfreq value=1.5876
puthd in=mosfxc-1733-130-1640/restfreq value=1.640

# now look for solar interference.  should be wavy baselines in both pols, particularly on short baselinses.

smauvspec device=1/xs axis=ch,bo select='pol(xx),-auto,uvrange(0.001,0.1)' nxy='4,3' vis=fx64c-1733-130-1640_1

# seems ok.

# plot phase of each baseline for calibrator as a function of time.  look for erratic behavior.  looks fine.

# now run bandpass and flux calibration

lupus>smamfcal options=opolyfit,msmooth select=-auto polyfit=4 smooth=15 refant=13 line=chan,800,100 vis=fx64c-1733-130-1640-xx
lupus>smamfcal options=opolyfit,msmooth select=-auto polyfit=4 smooth=15 refant=13 line=chan,800,100 vis=fx64c-1733-130-1640-yy
smamfcal: Version 1.14, 2008/07/18 20:40:10 UTC

Reading the data ...
Smoothing the spectral data ...
Number of solution intervals: 15
### Warning [smamfcal]:  Correlations flagged or edge-rejected: 19940700
Number correlations accepted: 25268100
Number of frequency bands/settings: 1
Number of polarisations selected: 1
Initialising ...
Generating initial solution estimate ...
Doing solution refinement ...
Iter= 1, Solution Error:  0.631
Iter= 2, Solution Error:  0.016
Iter= 3, Solution Error:  0.001
I flux density:    0.000
Saving solution ...

# bandpass cal looks pretty bad.  seems to be influenced by rfi in spectral half 1.  also, gain calibration seems to not change the flux scale at all.  looks like 1733-130 is not known by miriad.
# although plotting amp vs uvdistance shows that gain cal helped quite a bit.

uvplt vis=fx64c-1733-130-1640-yy select=-auto axis=uvdistance,amp options=nobase device=1/xs

# now need to apply selfcal to set flux scale for 1733-130 flux to 5.2 Jy (vla calibrator list).  'mselfcal' complains; 'selfcal' says file is "mixed".  ah, "mixed" means it has cross and auto correlations;  need to filter out autocorr.

lupus>selfcal select=-auto options=amp,noscale flux=5.2 vis=fx64c-1733-130-1640-yy
Selfcal: version 1.0 21-Nov-2008
Model is a point source at the observing center
### Warning [selfcal]:  vis file is mixed. use select=-auto
Reading the visibility file ...
Accumulating statistics ...
Finding the selfcal solutions ...
Total number of visibilities processed: 56511
Total number of solution intervals: 18
Rms of the gain phases (degrees):  74.4
Rms deviation of gain from 1: 0.707
Ratio of Actual to Theoretical noise: 8.629E-05

# tidy up header info

lupus>puthd type=double value=0.02 in=fx64c-1733-130-1640-xx/interval
PUTHD: Version 1.0 13-dec-96
lupus>puthd type=double value=0.02 in=fx64c-1733-130-1640-yy/interval
PUTHD: Version 1.0 13-dec-96

# now try peter's calctsys to set the proper jy/k for each antenna.  again hack to get python2.5 to run his script...

lupus>../../../code/mmm/pwilliams/fancy/calctsys quant=16,1 flux=5.2 vis=fx64c-1733-130-1640-yy out=fx64c-1733-130-1640-yy.ts
CALCTSYS: compute TSys values from data noise properties (Python, SVN r250, modified 2009-01-27 01:50:15Z)
Configuration:
  Assuming data are uncalibrated, using source flux 5.2
  Flagging TSyses above 350
  Averaging interval: 5.00000 minutes
  Using quantization efficiency for 16 levels and 1 times Nyquist sampling
  Quantization efficiency: 0.97
Applying bandpass corrections to fx64c-1733-130-1640-yy
Applying gain corrections to fx64c-1733-130-1640-yy
Computing temps in Kelvin, using Jy/K = 200.0 (from "jyperk" in dataset)
Iteratively flagging ...
   Pseudo-RChiSq: 461.086364735
      Flagging antpol 28Y: TSys 662.321 > 350.000
      Flagging antpol 14Y: TSys 454.327 > 350.000
   Pseudo-RChiSq: 215.187371714

Systemp solutions:
    1Y 45.0761 (3.50303)   3Y 46.5694 (3.60403)   4Y 45.1488 (6.67986)   5Y 227.698 (17.7517)
    6Y 65.5327 (6.78865)   8Y 46.9451 (4.01119)  11Y 53.6750 (6.56655)  12Y 48.4760 (8.35554)
   13Y 45.4310 (3.24528)  15Y 248.420 (26.1268)  16Y 50.8123 (4.81601)  17Y 281.853 (8.93506)
   22Y 326.783 (22.6716)  23Y 173.139 (29.8722)  25Y 42.2756 (4.21197)  27Y 43.0007 (6.36446)
   32Y 42.6211 (10.5048)  33Y 43.3429 (13.3102)  36Y 46.2304 (11.9572)  37Y 50.0482 (10.5488)
   39Y 251.915 (24.0833)  40Y 267.616 (22.6745)  41Y 43.7717 (6.48673)  42Y 244.367 (14.7156)

Worst residuals:
   23Y-42Y -32.9815  15Y-22Y  33.2927  33Y-37Y  33.6510  23Y-32Y  39.0649  22Y-23Y -42.3918
   33Y-36Y  48.8870  23Y-39Y -54.4436   5Y-22Y  72.6059  39Y-40Y  90.2768  15Y-23Y  108.113

Computing temps in Kelvin, using Jy/K = 200.0 (from "jyperk" in dataset)
Iteratively flagging ...
   Pseudo-RChiSq: 369.251949738
      Flagging antpol 28Y: TSys 610.478 > 350.000
      Flagging antpol 14Y: TSys 431.486 > 350.000
   Pseudo-RChiSq: 279.392957223

Systemp solutions:
    1Y 45.3058 (4.63399)   3Y 44.5165 (3.76561)   4Y 44.9720 (8.76846)   5Y 252.971 (18.3686)
    6Y 64.1571 (5.88529)   8Y 48.5532 (3.03039)  11Y 51.0092 (5.52055)  12Y 47.8169 (6.89769)
   13Y 43.9328 (6.35497)  15Y 257.211 (19.0367)  16Y 52.1960 (8.32476)  17Y 287.771 (20.3945)
   22Y 339.843 (20.0280)  23Y 176.975 (40.2713)  25Y 42.9086 (4.51792)  27Y 45.2261 (7.43135)
   32Y 38.7444 (5.70260)  33Y 39.5012 (5.00933)  36Y 41.6343 (4.93393)  37Y 46.3751 (8.39835)
   39Y 253.796 (14.2409)  40Y 311.736 (41.0610)  41Y 45.7916 (12.1274)  42Y 253.735 (19.3806)

Worst residuals:
     4Y-5Y  35.7151  15Y-40Y -38.2031   5Y-42Y  39.9315  22Y-40Y -41.7919  22Y-23Y -44.7260
   17Y-22Y  45.6600  40Y-41Y  45.8205   5Y-15Y  47.8954  17Y-42Y -56.8038  23Y-40Y  175.574

#... iterates many times until...

Computing temps in Kelvin, using Jy/K = 200.0 (from "jyperk" in dataset)
Iteratively flagging ...
   Pseudo-RChiSq: 3182.20760362
      Flagging antpol 28Y: TSys 633.789 > 350.000
      Flagging antpol 14Y: TSys 406.471 > 350.000
   Pseudo-RChiSq: 2935.46018364

Systemp solutions:
    1Y 48.0754 (8.16725)   3Y 51.9747 (7.23132)   4Y 59.8166 (82.9660)   5Y 284.384 (87.7743)
    6Y 80.8045 (13.3844)   8Y 54.2297 (9.55147)  11Y 64.6482 (42.7748)  12Y 71.5831 (22.3117)
   13Y 60.2582 (11.3466)  15Y 280.461 (56.2309)  16Y 60.0938 (9.92370)  17Y 278.585 (19.1572)
   22Y 336.693 (70.7231)  23Y 197.393 (18.7812)  25Y 51.2330 (12.3564)  27Y 71.0624 (12.0268)
   32Y 58.3826 (15.1706)  33Y 49.9365 (19.1897)  36Y 57.8050 (21.7795)  37Y 60.3834 (20.5376)
   39Y 334.629 (128.198)  40Y 298.370 (111.906)  41Y 54.7244 (32.4425)  42Y 283.829 (78.1510)

Worst residuals:
   22Y-40Y -73.5006  22Y-33Y  77.1589  36Y-37Y  83.1850  15Y-42Y  112.386  40Y-41Y  146.745
   11Y-22Y  182.814  15Y-22Y  219.488  39Y-42Y  337.800    4Y-5Y  393.049  39Y-40Y  496.828

Applying bandpass corrections to fx64c-1733-130-1640-yy
Applying gain corrections to fx64c-1733-130-1640-yy

# guessing that that's mostly ok...  now try to image using peter's quick imaging script

lupus>micr.sh fx64c-1733-130-1640-xx.ts
+ rm -rf fx64c-1733-130-1640-xx.ts.mp fx64c-1733-130-1640-xx.ts.bm fx64c-1733-130-1640-xx.ts.cl fx64c-1733-130-1640-xx.ts.rm
+ invert vis=fx64c-1733-130-1640-xx.ts map=fx64c-1733-130-1640-xx.ts.mp beam=fx64c-1733-130-1640-xx.ts.bm select=-auto options=double,mfs sup=0
Invert: version 1.0 14-oct-08
Reading the visibility data ...
Making MFS images
Visibilities accepted: 21458448
### Warning [invert]:  Visibilities rejected: 36408816
Mean Frequency(GHz):     1.64
Sidelobe suppression area is 35x35 arcsec
 ... this corresponds to natural weighting
Applying the weights ...
Theoretical rms noise: 2.060E-03
Forming the beam ...
Finished gridding  50% ...
Forming Stokes I  image ...
Completed 100% !
+ clean map=fx64c-1733-130-1640-xx.ts.mp beam=fx64c-1733-130-1640-xx.ts.bm out=fx64c-1733-130-1640-xx.ts.cl niters=5000
Clean: version 4-Feb-08
Begin iterating
 Clark  Iterations: 10
 Residual min,max,rms:   -9.399E-02   1.845E+00   4.751E-02
 Total CLEANed flux:    3.446E+00
Max component, vs rms:    5.291E+00   1.114E+02
 Clark  Iterations: 29
 Residual min,max,rms:   -4.069E-02   2.492E-01   1.362E-02
 Total CLEANed flux:    5.042E+00
Max component, vs rms:    1.845E+00   1.354E+02
 Clark  Iterations: 223
 Residual min,max,rms:   -2.793E-02   3.783E-02   8.972E-03
 Total CLEANed flux:    6.142E+00
Max component, vs rms:    2.492E-01   2.778E+01
 Clark  Iterations: 5000
 Residual min,max,rms:   -1.845E-02   2.064E-02   5.496E-03
 Total CLEANed flux:    6.552E+00
Max component, vs rms:    3.783E-02   6.884E+00
 Stopping -- Maximum iterations performed
+ restor map=fx64c-1733-130-1640-xx.ts.mp beam=fx64c-1733-130-1640-xx.ts.bm model=fx64c-1733-130-1640-xx.ts.cl out=fx64c-1733-130-1640-xx.ts.rm
Restor: version 1.3 07-Feb-2002
Using gaussian beam fwhm of  218.830 by  168.887 arcsec.
Position angle:  -44.3 degrees.

# and display

lupus>cgdisp slev=p,1 levs1=10,5,1,0.5,0.1 device=1/xs options=wedge beamtyp=b,l labtyp=arcsec,arcsec in=fx64c-1733-130-1640-xx.ts.rm,fx64c-1733-130-1640-xx.ts.rm type=contour,pixel

# looks pretty clean.  some stripes at a level of 0.1%.

# what does phase solution look like as function of time?

gpplt device=1/xs vis=fx64c-1733-130-1640-yy yaxis=phase nxy=5,3

# looks ok.  phase rms generally around 10deg.  ??what is ideal?  acceptable??

# now copy cal solution over to flagged target field (gcmosaic1).

# actually, first need to check closure phase of field for bad ants...
# xx => ant 42,41
# yy => ant 40
# then copy over the cal gain and bandpass solutions.  note intermediate step needed to keep from overwriting solution values

lupus>gpcopy vis=fx64c-1733-130-1640-xx out=fx64c-gcmosaictest1-1640-xx
lupus>uvcat vis=fx64c-gcmosaictest1-1640-xx out=fx64c-gcmosaictest1-1640-xx.mf
lupus>gpcopy vis=fx64c-1733-130-1640-xx.ts out=fx64c-gcmosaictest1-1640-xx.mf

# repeat for yy...
# also do uvplt of amplitude vs uvdist to see flux calibration and general quality.  seems ok.
# another step recommended by peter's cookbook.txt:  calctsys on target field.  this will empirically measure the tsys values for each antenna based on the transferred gains.  note that in gc fields there is a lot of flux, so default maxtsys limit will flag everything.  bumping it way up to grab the worst offenders.

lupus>../../../code/mmm/pwilliams/fancy/calctsys quant=16,1 vis=fx64c-gcmosaictest1-1640-xx.mf out=fx64c-gcmosaictest1-1640-xx.ts maxtsys=1000

# now image with micr.sh

# xx looks ok, yy a bit worse...  make hardcopy of xx.

cgdisp slev=p,1 levs1=10,1,0.1,0.01 device='gcmosaictest1-xx.ps/ps' options=wedge beamtyp=b,l labtyp=arcsec,arcsec in=fx64c-gcmosaictest1-1640-xx.ts.rm,fx64c-gcmosaictest1-1640-xx.ts.rm type=pixel range=0,0,log,0

####################################################################################################
####################################################################################################
# new thread for atafx product "mosfxc"
####################################################################################################
####################################################################################################

# set variables and inspect summary info

lupus>set SRC = 'gcmosaictest1'
lupus>set CAL = '1733-130'
lupus>set FREQ = '1640'
lupus>set VIS = mosfxc-${SRC}-${FREQ}
lupus>set CALVIS = mosfxc-${CAL}-${FREQ}

lupus>listobs vis=${VIS}
lupus>itemize in=${VIS}
lupus>prthd in=${VIS}

# check raw spectra.  see rfi!

lupus>smauvspec vis=${CALVIS} device=1/xs axis=ch,bo select='pol(xx,yy),ant(1,2,3)(11,12,13,14)' nxy=4,3 interval=100

# run karto's flagger

lupus>newrfisweep.csh vis=${CALVIS}

mosfxc-1733-130-1640 final flagging...
UvAver: version 1.0 17-Nov-08
Uvaflag: version 1.0 22-Oct-98
 Correlations: Total   Good      Bad
 Before:    ****************  209385
 After:     ****************30145500
Edge flagging mosfxc-1733-130-1640
Flagging of mosfxc-1733-130-1640 complete!
Flagging process took 8 minute(s) 6 second(s).

# doesn't catch all the rfi that is persistent from 1600-1610 MHz and up around 1685-1690 MHz
# flag all of that completely

lupus>uvflag vis=${CALVIS} line='chan,100,100,1,1' flagval='flag'
lupus>uvflag vis=${CALVIS} line='chan,100,840,1,1' flagval='flag'
lupus>uvflag vis=${VIS} line='chan,100,100,1,1' flagval='flag'
lupus>uvflag vis=${VIS} line='chan,100,840,1,1' flagval='flag'

# try rerunning newrfisweep.csh, since it may choke on superbad rfi
# still doesn't change much.  a bit of trouble at channels 320-330.  flagging manually.

lupus>uvflag vis=${VIS} line='chan,10,320,1,1' flagval='flag'
lupus>uvflag vis=${CALVIS} line='chan,10,320,1,1' flagval='flag'

# reasonably happy with flagging now.  what are stats?
# ?? does this mean that 6.9e6 visibilities are flagged out of 8.7e8??

lupus>itemize in=${CALVIS}

itemize: Version 1.4, 2008/02/19 20:06:29 UTC

  sfreq    = 1.5876
  freq     = 1.64000001
  vislen   = 872640448
  ncorr    = 214410240
  nwcorr   = 0
  obstype  = mixed-auto-cross
  npol     = 4
  restfreq = 1.64
  flags      (integer data, 6916460 elements)
  specdata   (text data, 36415864 elements)
  vartable   (text data, 425 elements)
  history    (text data, 270952 elements)
  visdata    (binary data, 872640444 elements)

# not sure...  moving on...
# uvcal to flatten baselines by dividing by autocorrs

lupus>uvcal options=fxcal,unflagged select='pol(xx)' vis=${CALVIS} out=${CALVIS}-xx
lupus>uvcal options=fxcal,unflagged select='pol(yy)' vis=${CALVIS} out=${CALVIS}-yy

# uvspec shows that it looks a bit better.  also checked that autocorrs weren't wonky.

# check for solar interference effects on short baselines

lupus>smauvspec device=1/xs axis=ch,bo select='pol(xx),-auto,uvrange(0.001,0.1)' nxy=4,3 vis=${CALVIS}-xx interval=1

# some bad low channels (probably not solar, but anyway worth flagging).  baseline 4,5 shows wavy amp and phase often.  ??why??

# flagging chans 200-210.  clearly limited in time. ?? how to find/select smartly??  need 2d flag inspection...

lupus>uvflag vis=${CALVIS}-xx line='chan,10,200,1,1' flagval=f
# etc...

# now use closanal to find bad ants/bl

lupus>~/big_scr2/code/mmm/pwilliams/fancy/closanal vis=${CALVIS}-xx interval=10

# 42x, 26x, 14x clearly bad.
# 24y, 28y, 42y, 39y clearly bad.

# alternatively could use garretts "newcalcal"

lupus>uvflag vis=${VIS}-xx select='ant(26)' flagval=f
lupus>uvflag vis=${CALVIS}-xx select='ant(26)' flagval=f
# etc.

# after this, the best and worst mean rms of antpols ranges from 5.6 to 7.6 for xx and 6.6 to 10.4 for yy.

# flagging ok! moving on to cal

lupus>smamfcal options=interp,opolyfit select=-auto polyfit=7 refant=${REFANT} line=chan,824,101 vis=${CALVIS}-xx
lupus>smamfcal options=interp,opolyfit select=-auto polyfit=7 refant=${REFANT} line=chan,824,101 vis=${CALVIS}-yy

# calibration looks ok, but flux scale off, since cal not known.  need selfcal.

lupus>selfcal select=-auto options=amp,noscale flux=5.2 vis=${CALVIS}-xx
lupus>selfcal select=-auto options=amp,noscale flux=5.2 vis=${CALVIS}-yy

# fix header

lupus>puthd type=double value=0.02 in=${CALVIS}-xx/interval
lupus>puthd type=double value=0.02 in=${CALVIS}-yy/interval

# check quality of cal.  phase shows all ants have rms of about 5-10 deg.  looks ok.  worst is 2x, which has jump of 30 deg.  

lupus>gpplt vis=${VIS}-xx device=1/xs yaxis=phase

# cal meaningful tsys

lupus>../../../code/mmm/pwilliams/fancy/calctsys quant=16,1 flux=5.2 vis=${CALVIS}-xx out=${CALVIS}-xx.ts
lupus>../../../code/mmm/pwilliams/fancy/calctsys quant=16,1 flux=5.2 vis=${CALVIS}-yy out=${CALVIS}-yy.ts

# image calibrator

lupus>~/big_scr2/code/mmm/pwilliams/micr.sh ${CALVIS}-xx.ts

lupus>cgdisp slev=p,1 levs1=10,5,1,0.5,0.1 device=1/xs options=wedge beamtyp=b,l labtyp=arcsec,arcsec in=${CALVIS}-xx.ts.rm,${CALVIS}-xx.ts.rm type=contour,pixel

# calibrator image shows compact, 1% sidelobes in xx and yy about about 0.5 deg out.  also yy shows very low freq vertical stripes.  ?? ok??

# now clean up target field.

lupus>newrfisweep.csh vis=${VIS}

# looks pretty good.  note that worst parts were flagged out during cal flagging.

lupus>uvcal options=fxcal,unflagged select='pol(xx)' vis=${VIS} out=${VIS}-xx
lupus>uvcal options=fxcal,unflagged select='pol(yy)' vis=${VIS} out=${VIS}-yy

# plot shows that baselines are a bit flatter...

lupus>smauvspec device=1/xs axis=ch,bo select='pol(yy),ant(1,2,3)(12,13,14,15)' nxy=4,3 vis=${VIS} interval=1

# copy over first gains and bandpass here

lupus>gpcopy vis=${CALVIS}-xx out=${VIS}-xx
lupus>gpcopy vis=${CALVIS}-yy out=${VIS}-yy

# solidify

lupus>uvcat vis=${VIS}-xx out=${VIS}-xx.mf
lupus>uvcat vis=${VIS}-yy out=${VIS}-yy.mf

# copy selfcal gain values over...

lupus>gpcopy vis=${CALVIS}-yy.ts out=${VIS}-yy.mf
lupus>gpcopy vis=${CALVIS}-xx.ts out=${VIS}-xx.mf

# now calculate proper tsys values.  note that default maxtsys will flag everything.  gc is bright!  note yy looked a bit worse in closure phase earlier, so i'm increaseing maxtsys for them here.

lupus>~/big_scr2/code/mmm/pwilliams/fancy/calctsys quant=16,1 vis=${VIS}-xx.mf out=${VIS}-xx.ts maxtsys=800
lupus>~/big_scr2/code/mmm/pwilliams/fancy/calctsys quant=16,1 vis=${VIS}-yy.mf out=${VIS}-yy.ts maxtsys=900

# images show a bit of large-scale emission.  uvspec of cal shows phase wobbles (like small wrap) on short baselinse => solar interference!
# flag baselines under 100 lambda.

lupus>uvflag vis=${VIS}-xx select='uvrange(0.001,0.1)' flagval=flag
#etc.

